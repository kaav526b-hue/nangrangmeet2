// ì „ì—­ ë³€ìˆ˜ ì„¤ì • (Canvas í™˜ê²½ì—ì„œ ì œê³µë¨)
const appId = 'nangrangmeet2'; // <<-- ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„ì„ ì•± IDë¡œ ì‚¬ìš© (ìˆ˜ì •ë¨)

// ====================================================================
// ğŸš¨ğŸš¨ğŸš¨ [í•„ìˆ˜] ì´ ë¶€ë¶„ì„ ì‚¬ìš©ìë‹˜ì˜ Firebase ì„¤ì • ì •ë³´ë¡œ ë°˜ë“œì‹œ êµì²´í•˜ì„¸ìš”! ğŸš¨ğŸš¨ğŸš¨
// GitHub Pagesì—ì„œ Firebase ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ì´ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.
// Firebase ì½˜ì†” > í”„ë¡œì íŠ¸ ì„¤ì • > ì›¹ ì•± ì„¤ì • -> ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
// ====================================================================
const firebaseConfig = {
    apiKey: "YOUR_API_KEY_HERE", 
    authDomain: "YOUR_AUTH_DOMAIN_HERE", 
    projectId: "YOUR_PROJECT_ID_HERE",
    storageBucket: "YOUR_STORAGE_BUCKET_HERE",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID_HERE",
    appId: "YOUR_APP_ID_HERE"
};
// ====================================================================

const initialAuthToken = null; // GitHub Pagesì—ì„œëŠ” ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ nullë¡œ ì„¤ì •

// ê´€ë¦¬ì ì ‘ê·¼ ë¹„ë°€ë²ˆí˜¸ (ê°„ë‹¨í•œ ë³´ì•ˆ ì¥ì¹˜, ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ ì²˜ë¦¬í•´ì•¼ í•¨)
const ADMIN_KEY = "018515"; 

// --------------------------------------------------------
// ğŸš¨ ì´ê³³ì„ ìˆ˜ì •í•˜ì—¬ ì°¸ê°€ì ë‹‰ë„¤ì„ ë¦¬ìŠ¤íŠ¸ë¥¼ ë³€ê²½í•˜ì„¸ìš”! (ì´ 32ëª…) ğŸš¨
// --------------------------------------------------------
const FULL_PARTICIPANT_LIST = [
    { class: 'í–‡ë‹˜ë°˜', num: '01', name: 'ê¹€ë¯¼ì¤€' }, { class: 'ë‹¬ë‹˜ë°˜', num: '01', name: 'ì´ì„œìœ¤' },
    { class: 'í–‡ë‹˜ë°˜', num: '02', name: 'ë°•ì§€í›ˆ' }, { class: 'ë‹¬ë‹˜ë°˜', num: '02', name: 'ìµœì•„ë¦°' },
    { class: 'í–‡ë‹˜ë°˜', num: '03', name: 'ì´ë„í˜„' }, { class: 'ë‹¬ë‹˜ë°˜', num: '03', name: 'ê¹€ì˜ˆë‚˜' },
    { class: 'í–‡ë‹˜ë°˜', num: '04', name: 'ì •ìš°ì„±' }, { class: 'ë‹¬ë‹˜ë°˜', num: '04', name: 'í•œì§€ìš°' },
    { class: 'í–‡ë‹˜ë°˜', num: '05', name: 'ì¡°ìŠ¹í˜„' }, { class: 'ë‹¬ë‹˜ë°˜', num: '05', name: 'ì˜¤í•˜ëŠ˜' },
    { class: 'í–‡ë‹˜ë°˜', num: '06', name: 'ìœ¤ì¬ë¯¼' }, { class: 'ë‹¬ë‹˜ë°˜', num: '06', name: 'ì„œì€ì±„' },
    { class: 'í–‡ë‹˜ë°˜', num: '07', name: 'ì¥í˜ì§„' }, { class: 'ë‹¬ë‹˜ë°˜', num: '07', name: 'ê³ ìœ ì§„' },
    { class: 'í–‡ë‹˜ë°˜', num: '08', name: 'ì†¡ê±´ìš°' }, { class: 'ë‹¬ë‹˜ë°˜', num: '08', name: 'ë¬¸ì†Œí¬' },
    { class: 'í–‡ë‹˜ë°˜', num: '09', name: 'ê°•íƒœì–‘' }, { class: 'ë‹¬ë‹˜ë°˜', num: '09', name: 'ì„ì±„ì›' },
    { class: 'í–‡ë‹˜ë°˜', num: '10', name: 'ì‹ í˜„ìš°' }, { class: 'ë‹¬ë‹˜ë°˜', num: '10', name: 'ë°°ìˆ˜ë¯¼' },
    { class: 'í–‡ë‹˜ë°˜', num: '11', name: 'í™©ì¤€ì„œ' }, { class: 'ë‹¬ë‹˜ë°˜', num: '11', name: 'ë¥˜ë‹¤ì¸' },
    { class: 'í–‡ë‹˜ë°˜', num: '12', name: 'ì „ì˜í˜¸' }, { class: 'ë‹¬ë‹˜ë°˜', num: '12', name: 'ë¯¼ì£¼ì•„' },
    { class: 'í–‡ë‹˜ë°˜', num: '13', name: 'ì˜¤ìƒë¯¼' }, { class: 'ë‹¬ë‹˜ë°˜', num: '13', name: 'ê³µì„œì˜' },
    { class: 'í–‡ë‹˜ë°˜', num: '14', name: 'ë³€ì •ìˆ˜' }, { class: 'ë‹¬ë‹˜ë°˜', num: '14', name: 'ìœ¡ì˜ˆì§„' },
    { class: 'í–‡ë‹˜ë°˜', num: '15', name: 'ì–‘ì„±ì¬' }, { class: 'ë‹¬ë‹˜ë°˜', num: '15', name: 'ì£¼ì€ì„œ' },
    { class: 'í–‡ë‹˜ë°˜', num: '16', name: 'ìœ ë™í›ˆ' }, { class: 'ë‹¬ë‹˜ë°˜', num: '16', name: 'ì§„í˜œë¦¬' }
];

// --------------------------------------------------------
// 0. Globals for Listener Management
// --------------------------------------------------------
let participantsUnsubscribe = null;
let matchesUnsubscribe = null;

let app;
let db;
let auth;
let currentUserId = null;
let currentUserNickname = 'ë¯¸ì •';
let currentRole = 'none';
let isAdminValidated = false; // ê´€ë¦¬ì ì¸ì¦ ì„±ê³µ ì—¬ë¶€ í”Œë˜ê·¸

// ë°ì´í„° ìƒíƒœ
let participants = []; // Firestoreì— ë“±ë¡ëœ ì°¸ê°€ì (ë‹‰ë„¤ì„ ë“±ë¡ ì™„ë£Œì)
let submissions = {}; // Key: userId, Value: {choice1, choice2, choice3}
let finalMatches = [];
let isMatchInProgress = false;

// --------------------------------------------------------
// 1. Firebase ì´ˆê¸°í™” ë° ì¸ì¦
// --------------------------------------------------------
async function initializeFirebase() {
    try {
        // Firebase Configê°€ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸
        if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes('YOUR_API_KEY_HERE')) {
            document.getElementById('system-status').textContent = 'ğŸš¨ ì˜¤ë¥˜: Firebase ì„¤ì • ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. index.html íŒŒì¼ì˜ firebaseConfig ë¶€ë¶„ì„ ìˆ˜ì •í•´ì£¼ì„¸ìš”.';
            console.error("Firebase Config Error: Configuration object is missing or invalid. Please update the firebaseConfig object in index.html with your actual Firebase project settings.");
            return; 
        }

        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        document.getElementById('system-status').textContent = 'ì¸ì¦ ë° ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì¤‘...';

        // ì¸ì¦ ì²˜ë¦¬ (GitHub Pagesì—ì„œëŠ” ìµëª… ì¸ì¦ë§Œ ì‚¬ìš©)
        if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
        } else {
            await signInAnonymously(auth);
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                document.getElementById('user-id').textContent = currentUserId; 
                document.getElementById('system-status').textContent = 'ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ. ì—­í• ì„ ì„ íƒí•˜ì„¸ìš”.';
                setupParticipant(currentUserId);
                startListeners(); // ì¸ì¦ í›„ ë¦¬ìŠ¤ë„ˆ ì‹œì‘
            } else {
                console.error("ì¸ì¦ ì‹¤íŒ¨: ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                document.getElementById('system-status').textContent = 'ì¸ì¦ ì‹¤íŒ¨';
            }
        });

    } catch (error) {
        console.error("Firebase ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        document.getElementById('system-status').textContent = `ì˜¤ë¥˜: ${error.message}`;
    }
}

/**
 * ì‚¬ìš©ìê°€ ì²˜ìŒ ì ‘ì†í•˜ê±°ë‚˜ ì¸ì¦ë  ë•Œ ë‹‰ë„¤ì„ ì„¤ì • ë° ì°¸ê°€ì ëª©ë¡ì— ë“±ë¡
 */
async function setupParticipant(userId) {
    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'participants', userId);

    try {
        const docSnap = await getDoc(docRef);
        const nicknamePattern = /^(í–‡ë‹˜ë°˜|ë‹¬ë‹˜ë°˜)\s\d{2}\s.+$/; // ì˜ˆ: í–‡ë‹˜ë°˜ 01 ê¹€ê°œë˜¥

        let userNeedsSetup = true;

        if (docSnap.exists()) {
            const data = docSnap.data();
            if (data.nickname && nicknamePattern.test(data.nickname)) {
                // ìœ íš¨í•œ í˜•ì‹ì˜ ë‹‰ë„¤ì„ì´ ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆìŒ
                currentUserNickname = data.nickname;
                userNeedsSetup = false;
            } else {
                // ë‹‰ë„¤ì„ì´ ìˆì§€ë§Œ í˜•ì‹ì´ ìœ íš¨í•˜ì§€ ì•ŠìŒ (ì´ì „ ì„ì‹œ ë‹‰ë„¤ì„ ë“±)
                currentUserNickname = 'ë‹‰ë„¤ì„ ì¬ì„¤ì • í•„ìš”';
            }
        }

        document.getElementById('user-nickname').textContent = currentUserNickname;
        
        // FIX: currentRoleì´ 'none'ì´ ì•„ë‹ ë•Œë§Œ ë·° ë Œë”ë§ í•¨ìˆ˜ í˜¸ì¶œí•˜ì—¬ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
        if (currentRole === 'participant') {
            if (userNeedsSetup) {
                renderSetupForm(); // ì°¸ê°€ì ëª¨ë“œì´ê³  ì„¤ì •ì´ í•„ìš”í•˜ë©´ í¼ ë Œë”ë§
            } else {
                 renderParticipantView(); // ì°¸ê°€ì ëª¨ë“œì´ê³  ì„¤ì • ì™„ë£Œ ì‹œ ë·° ë Œë”ë§
            }
        }

    } catch (e) {
        console.error("ì°¸ê°€ì ì„¤ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
        showModal(`ì°¸ê°€ì ì •ë³´ ë¡œë“œ ì˜¤ë¥˜: ${e.message}`, false);
    }
}

/**
 * ë‹‰ë„¤ì„ ì„¤ì •ì„ ìœ„í•œ í¼ ë Œë”ë§ (ì°¸ê°€ì ëª¨ë“œ)
 */
function renderSetupForm() {
    const container = document.getElementById('mode-container');
    const classOptions = ['í–‡ë‹˜ë°˜', 'ë‹¬ë‹˜ë°˜'].map(c => `<option value="${c}">${c}</option>`).join('');
    const numOptions = Array.from({ length: 16 }, (_, i) => (i + 1).toString().padStart(2, '0'))
        .map(n => `<option value="${n}">${n}ë²ˆ</option>`).join('');

    container.innerHTML = `
        <div class="max-w-md mx-auto p-8 bg-purple-50 rounded-xl shadow-lg border border-purple-200 mt-6">
            <h2 class="text-2xl font-bold text-purple-800 mb-6 text-center">ğŸƒ ì°¸ê°€ì ë‹‰ë„¤ì„ ë“±ë¡ ğŸƒ</h2>
            <p class="text-sm text-gray-600 mb-6 text-center">ìì‹ ì˜ ê·¸ë£¹ê³¼ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ë©´ ì´ë¦„ì´ ìë™ í™•ì •ë©ë‹ˆë‹¤.</p>
            
            <form id="setup-form" onsubmit="submitSetupForm(event)" class="space-y-4">
                <div class="flex flex-col space-y-1">
                    <label for="setup-class" class="font-semibold text-gray-700">1. ê·¸ë£¹ ì„ íƒ</label>
                    <select id="setup-class" required onchange="updateCalculatedNickname()" class="w-full p-3 border border-purple-300 rounded-lg bg-white">
                        <option value="">-- ê·¸ë£¹ì„ ì„ íƒí•˜ì„¸ìš” --</option>
                        ${classOptions}
                    </select>
                </div>
                
                <div class="flex flex-col space-y-1">
                    <label for="setup-num" class="font-semibold text-gray-700">2. ë²ˆí˜¸ ì„ íƒ (01~16)</label>
                    <select id="setup-num" required onchange="updateCalculatedNickname()" class="w-full p-3 border border-purple-300 rounded-lg bg-white">
                        <option value="">-- ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
                        ${numOptions}
                    </select>
                </div>
                
                <div id="calculated-nickname" data-nickname="" class="mt-4 p-4 bg-white rounded-lg border-2 border-dashed border-blue-300 text-center">
                    <p class="text-gray-500">ê·¸ë£¹ê³¼ ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                </div>

                <button type="submit" disabled class="w-full py-3 mt-6 text-white font-bold rounded-lg bg-purple-600 hover:bg-purple-700 transition shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed">
                    ë‹‰ë„¤ì„ ë“±ë¡ ë° ì°¸ê°€ ì‹œì‘
                </button>

                <p id="setup-error" class="text-red-500 text-sm mt-3 text-center hidden"></p>
            </form>
        </div>
    `;

    // ì´ˆê¸° ë‹‰ë„¤ì„ ì—…ë°ì´íŠ¸ (ì˜µì…˜ì´ ë¡œë“œëœ í›„ í•œ ë²ˆ ì‹¤í–‰)
    updateCalculatedNickname();
}

/**
 * ê·¸ë£¹ê³¼ ë²ˆí˜¸ ì„ íƒì— ë”°ë¼ ë‹‰ë„¤ì„ì„ ê³„ì‚°í•˜ê³  í‘œì‹œí•©ë‹ˆë‹¤.
 */
function updateCalculatedNickname() {
    const groupSelect = document.getElementById('setup-class');
    const numSelect = document.getElementById('setup-num');
    const nicknameDisplay = document.getElementById('calculated-nickname');
    const submitButton = document.getElementById('setup-form').querySelector('button[type="submit"]');

    const selectedGroup = groupSelect.value;
    const selectedNum = numSelect.value;

    submitButton.disabled = true;
    nicknameDisplay.dataset.nickname = "";

    if (!selectedGroup || !selectedNum) {
        nicknameDisplay.innerHTML = `<p class="text-gray-500">ê·¸ë£¹ê³¼ ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.</p>`;
        return;
    }

    // Groupê³¼ Numberì— ë§¤ì¹­ë˜ëŠ” Nameì„ ì°¾ìŠµë‹ˆë‹¤.
    const participant = FULL_PARTICIPANT_LIST.find(p => 
        p.class === selectedGroup && p.num === selectedNum
    );

    if (participant) {
        const calculatedNickname = `${participant.class} ${participant.num} ${participant.name}`;
        nicknameDisplay.innerHTML = `
            <p class="text-sm font-semibold text-gray-700">í™•ì •ë  ë‹‰ë„¤ì„:</p>
            <p class="text-xl font-bold text-blue-600 mt-1">${calculatedNickname}</p>
        `;
        // ê³„ì‚°ëœ ë‹‰ë„¤ì„ì„ datasetì— ì €ì¥í•˜ì—¬ submit í•¨ìˆ˜ì—ì„œ ì‚¬ìš©
        nicknameDisplay.dataset.nickname = calculatedNickname; 
        submitButton.disabled = false;
    } else {
        nicknameDisplay.innerHTML = `<p class="text-red-500 font-bold">ì˜¤ë¥˜: í•´ë‹¹ ê·¸ë£¹/ë²ˆí˜¸ ì¡°í•©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
        submitButton.disabled = true;
    }
}

/**
 * ë‹‰ë„¤ì„ ì„¤ì • í¼ ì œì¶œ ì²˜ë¦¬
 */
async function submitSetupForm(event) {
    event.preventDefault();
    const form = event.target;
    const errorElement = document.getElementById('setup-error');
    errorElement.classList.add('hidden');

    const nicknameDisplay = document.getElementById('calculated-nickname');
    const newNickname = nicknameDisplay.dataset.nickname;

    if (!newNickname) {
        errorElement.textContent = 'ê·¸ë£¹ê³¼ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì—¬ ë‹‰ë„¤ì„ì„ í™•ì •í•´ì£¼ì„¸ìš”.';
        errorElement.classList.remove('hidden');
        return;
    }

    // 1. ì¤‘ë³µëœ ë‹‰ë„¤ì„ì´ ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ (ë‹‰ë„¤ì„ ìœ íš¨ì„±ì€ updateCalculatedNicknameì—ì„œ ì´ë¯¸ í™•ì¸ë¨)
    const isNicknameTaken = participants.some(p => p.nickname === newNickname);
    if (isNicknameTaken) {
        errorElement.textContent = `ì´ë¯¸ '${newNickname}' ë‹‰ë„¤ì„ìœ¼ë¡œ ë“±ë¡ëœ ì°¸ê°€ìê°€ ìˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.`;
        errorElement.classList.remove('hidden');
        return;
    }

    showModal('ë‹‰ë„¤ì„ì„ ë“±ë¡í•˜ëŠ” ì¤‘...', true);

    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'participants', currentUserId);

    try {
        await setDoc(docRef, {
            nickname: newNickname,
            submitted: false,
            choice1: null, // ì´ì œ Nickname Stringì´ ì €ì¥ë¨
            choice2: null, // ì´ì œ Nickname Stringì´ ì €ì¥ë¨
            choice3: null, // ì´ì œ Nickname Stringì´ ì €ì¥ë¨
            finalMatch: null,
            timestamp: Date.now()
        }, { merge: true });

        currentUserNickname = newNickname;
        document.getElementById('user-nickname').textContent = newNickname;

        hideModal();
        showModal('âœ… ë‹‰ë„¤ì„ ë“±ë¡ ì™„ë£Œ! ìµœì¢… ì„ íƒì„ ì§„í–‰í•˜ì„¸ìš”.', false);
        renderParticipantView(); // ì„ íƒ í¼ ë Œë”ë§
    } catch (e) {
        console.error("ë‹‰ë„¤ì„ ë“±ë¡ ì˜¤ë¥˜:", e);
        showModal(`ë“±ë¡ ì‹¤íŒ¨: ${e.message}`, false);
    }
}


// --------------------------------------------------------
// 2. ì‹¤ì‹œê°„ ë°ì´í„° ë¦¬ìŠ¤ë„ˆ
// --------------------------------------------------------
function startListeners() {
    // FIX: ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ í•´ì œ (ì¤‘ë³µ êµ¬ë… ë° ë‚´ë¶€ ìƒíƒœ ì˜¤ë¥˜ ë°©ì§€)
    if (participantsUnsubscribe) {
        participantsUnsubscribe();
        participantsUnsubscribe = null;
    }
    if (matchesUnsubscribe) {
        matchesUnsubscribe();
        matchesUnsubscribe = null;
    }

    // 1. ì°¸ê°€ì ëª©ë¡ ë° ì„ íƒ í˜„í™© ë¦¬ìŠ¤ë„ˆ
    const participantsRef = collection(db, 'artifacts', appId, 'public', 'data', 'participants');
    participantsUnsubscribe = onSnapshot(participantsRef, (snapshot) => {
        participants = [];
        submissions = {};
        snapshot.forEach(doc => {
            const data = doc.data();
            const id = doc.id;

            participants.push({ id: id, ...data });

            // ì„ íƒ í˜„í™© ì—…ë°ì´íŠ¸
            if (data.submitted) {
                submissions[id] = {
                    choice1: data.choice1, // Nickname String
                    choice2: data.choice2, // Nickname String
                    choice3: data.choice3, // Nickname String
                    nickname: data.nickname
                };
            }
        });

        // ë‹‰ë„¤ì„ ìˆœìœ¼ë¡œ ì •ë ¬ (UI í¸ì˜ë¥¼ ìœ„í•´)
        participants.sort((a, b) => a.nickname.localeCompare(b.nickname));
        
        // í˜„ì¬ ì‚¬ìš©ìì˜ ë‹‰ë„¤ì„ì„ ë¡œì»¬ ìƒíƒœì— ë°˜ì˜
        const user = participants.find(p => p.id === currentUserId);
        if (user) {
             currentUserNickname = user.nickname;
             document.getElementById('user-nickname').textContent = currentUserNickname;
        }

        // FIX: currentRoleì´ 'none'ì´ ì•„ë‹ ë•Œë§Œ ë Œë”ë§ í•¨ìˆ˜ í˜¸ì¶œ
        if (currentRole === 'participant') {
            // setupParticipant ë‚´ë¶€ì—ì„œ ë Œë”ë§ì„ ì±…ì„ì§€ë„ë¡ í•¨
            setupParticipant(currentUserId); 
        } else if (currentRole === 'admin') {
            renderAdminView();
        }
    }, (error) => {
        console.error("ì°¸ê°€ì ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:", error);
    });

    // 2. ìµœì¢… ë§¤ì¹­ ê²°ê³¼ ë¦¬ìŠ¤ë„ˆ
    const matchesRef = collection(db, 'artifacts', appId, 'public', 'data', 'matches');
     matchesUnsubscribe = onSnapshot(matchesRef, (snapshot) => {
        if (!snapshot.empty) {
            // ìµœì‹  ê²°ê³¼ í•˜ë‚˜ë§Œ ì‚¬ìš©
            const latestMatch = snapshot.docs[0].data();
            finalMatches = latestMatch.result || [];
        } else {
            finalMatches = [];
        }

        // ë§¤ì¹­ ê²°ê³¼ê°€ ì—…ë°ì´íŠ¸ë˜ë©´ ì°¸ê°€ì ëª¨ë“œì™€ ê´€ë¦¬ì ëª¨ë“œë¥¼ ëª¨ë‘ ì—…ë°ì´íŠ¸
        if (currentRole === 'participant') {
            setupParticipant(currentUserId); // ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ì—¬ UIë¥¼ ì—…ë°ì´íŠ¸
        } else if (currentRole === 'admin') {
            renderAdminView();
        }

    }, (error) => {
        console.error("ë§¤ì¹­ ê²°ê³¼ ë¡œë“œ ì˜¤ë¥˜:", error);
    });
}

// --------------------------------------------------------
// 3. ì—­í•  ë° UI ë Œë”ë§ (ë³´ì•ˆ ê°•í™”)
// --------------------------------------------------------

/**
 * ê´€ë¦¬ì ëª¨ë“œ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬: ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ í•„ìš”
 */
function handleAdminClick() {
    if (isAdminValidated) {
        setRole('admin');
    } else {
        showAdminKeyInput();
    }
}

/**
 * ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í¼ ë Œë”ë§
 */
function showAdminKeyInput() {
    currentRole = 'none'; // ì¼ì‹œì ìœ¼ë¡œ ì—­í•  í•´ì œ
    const container = document.getElementById('mode-container');

    // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
    document.getElementById('btn-participant').classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700');
    document.getElementById('btn-participant').classList.add('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
    document.getElementById('btn-admin').classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
    
    container.innerHTML = `
        <div class="max-w-md mx-auto p-8 bg-yellow-50 rounded-xl shadow-lg border border-yellow-200 mt-6">
            <h2 class="text-2xl font-bold text-yellow-800 mb-4 flex items-center justify-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥
            </h2>
            <p class="text-sm text-gray-600 mb-4 text-center">ë§¤ì¹­ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            <input type="password" id="admin-key-input" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" class="w-full p-3 border border-yellow-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 mb-4 text-center">
            <button onclick="checkAdminKeyAndProceed()" class="w-full py-3 text-white font-bold rounded-lg bg-yellow-600 hover:bg-yellow-700 transition shadow-md">
                ê´€ë¦¬ì ëª¨ë“œ ì§„ì…
            </button>
            <p id="admin-key-error" class="text-red-500 text-sm mt-3 text-center hidden">ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (íŒíŠ¸: ${ADMIN_KEY})</p>
        </div>
    `;

    document.getElementById('admin-key-input').focus();
    document.getElementById('admin-key-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            checkAdminKeyAndProceed();
        }
    });
}

/**
 * ì…ë ¥ëœ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ê³  í†µê³¼í•˜ë©´ ê´€ë¦¬ì ëª¨ë“œë¡œ ì§„ì…
 */
function checkAdminKeyAndProceed() {
    const inputElement = document.getElementById('admin-key-input');
    const errorElement = document.getElementById('admin-key-error');

    if (!inputElement) return;

    const input = inputElement.value;

    if (input === ADMIN_KEY) {
        isAdminValidated = true;
        setRole('admin'); // ê²€ì¦ ì„±ê³µ í›„ ê´€ë¦¬ì ëª¨ë“œ ë Œë”ë§
    } else {
        errorElement.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
        errorElement.classList.remove('hidden');
        inputElement.value = ''; // ì…ë ¥ê°’ ì´ˆê¸°í™”
        inputElement.focus();
    }
}

/**
 * ì‚¬ìš©ì ì—­í•  ì„¤ì • ë° UI ì—…ë°ì´íŠ¸
 * @param {string} role 'participant' ë˜ëŠ” 'admin'
 */
function setRole(role) {
    // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
    document.getElementById('btn-participant').classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
    document.getElementById('btn-admin').classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
    
    if (role === 'participant') {
        document.getElementById('btn-participant').classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
        document.getElementById('btn-admin').classList.add('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
        currentRole = role;
        // ì°¸ê°€ì ëª¨ë“œ ì§„ì… ì‹œ ë‹‰ë„¤ì„ ì„¤ì • ì—¬ë¶€ í™•ì¸
        setupParticipant(currentUserId); 
    } else if (role === 'admin') {
        // ê´€ë¦¬ì ëª¨ë“œ ì§„ì… ì‹œì—ëŠ” ë°˜ë“œì‹œ isAdminValidatedê°€ trueì—¬ì•¼ í•¨
        if (!isAdminValidated) {
            handleAdminClick(); // ë‹¤ì‹œ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í™”ë©´ìœ¼ë¡œ ìœ ë„
            return;
        }
        document.getElementById('btn-admin').classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
        document.getElementById('btn-participant').classList.add('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
        currentRole = role;
        renderAdminView();
    }
}

/**
 * ì°¸ê°€ì ëª¨ë“œ UI ë Œë”ë§
 */
function renderParticipantView() {
    const container = document.getElementById('mode-container');
    const user = participants.find(p => p.id === currentUserId);
    const userNickname = user ? user.nickname : currentUserNickname;
    const nicknamePattern = /^(í–‡ë‹˜ë°˜|ë‹¬ë‹˜ë°˜)\s\d{2}\s.+$/;

    // 1. ë‹‰ë„¤ì„ ì„¤ì •ì´ ì•ˆ ë˜ì—ˆìœ¼ë©´ í¼ì„ ë³´ì—¬ì£¼ê³  ì¢…ë£Œ
    if (!nicknamePattern.test(userNickname)) {
         renderSetupForm();
         return;
    }

    // 2. ìµœì¢… ë§¤ì¹­ ê²°ê³¼ í‘œì‹œ
    if (user && user.finalMatch) {
        // finalMatchëŠ” ìƒëŒ€ë°© ID í˜¹ì€ 'ì†”ë¡œ' ë¬¸ìì—´
        const matchNickname = user.finalMatch === 'ì†”ë¡œ' ? 'ì†”ë¡œ' : (participants.find(p => p.id === user.finalMatch)?.nickname || 'ì•Œ ìˆ˜ ì—†ìŒ');
        container.innerHTML = `
            <div class="text-center p-8 bg-pink-50 border-4 border-pink-300 rounded-xl shadow-inner">
                <h2 class="text-2xl font-bold text-pink-700 mb-4">ğŸ‰ ìµœì¢… ì„ íƒ ê²°ê³¼ ğŸ‰</h2>
                <p class="text-3xl font-extrabold ${matchNickname === 'ì†”ë¡œ' ? 'text-gray-500' : 'text-pink-600'}">
                    ${matchNickname === 'ì†”ë¡œ' ? 'ğŸ˜­ ì†”ë¡œì…ë‹ˆë‹¤ ğŸ˜­' : `ë§¤ì¹­ ìƒëŒ€: ${matchNickname}`}
                </p>
            </div>
            <p class="text-center text-sm text-gray-500 mt-4">ë§¤ì¹­ ê²°ê³¼ëŠ” ê´€ë¦¬ìê°€ í™•ì •í•˜ë©´ í‘œì‹œë©ë‹ˆë‹¤.</p>
        `;
        return;
    }

    // 3. ì„ íƒ í¼ í‘œì‹œ ë° ìƒëŒ€ ê·¸ë£¹ í•„í„°ë§ (FULL_PARTICIPANT_LIST ê¸°ì¤€)
    
    // ì‚¬ìš©ìì˜ ê·¸ë£¹ì„ íŒŒì•…í•˜ì—¬ ìƒëŒ€ ê·¸ë£¹ì„ ê²°ì •
    const userClass = userNickname.split(' ')[0];
    const opponentClass = userClass === 'í–‡ë‹˜ë°˜' ? 'ë‹¬ë‹˜ë°˜' : 'í–‡ë‹˜ë°˜';

    // FULL_PARTICIPANT_LISTì—ì„œ ìƒëŒ€ ê·¸ë£¹ì˜ ë‹‰ë„¤ì„ ì „ì²´ë¥¼ ê°€ì ¸ì˜´
    const potentialOpponents = FULL_PARTICIPANT_LIST
        .filter(p => p.class === opponentClass)
        .map(p => `${p.class} ${p.num} ${p.name}`)
        .sort(); // ë‹‰ë„¤ì„ ìˆœìœ¼ë¡œ ì •ë ¬

    const isSubmitted = user ? user.submitted : false;

    // ì„ íƒ ì˜µì…˜ì€ Nickname Stringì„ valueë¡œ ê°€ì§‘ë‹ˆë‹¤. (UIDê°€ ì•„ë‹˜)
    const selectionOptions = potentialOpponents.map(nickname =>
        `<option value="${nickname}">${nickname}</option>`
    ).join('');

    // ì„ íƒ ì˜µì…˜ì´ 3ê°œ ë¯¸ë§Œì¼ ê²½ìš°ëŠ” ì°¸ê°€ì ë¦¬ìŠ¤íŠ¸ ì„¤ì • ì˜¤ë¥˜ì´ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” ë³„ë„ ê²½ê³  ì—†ì´ ì§„í–‰
    // (FULL_PARTICIPANT_LISTëŠ” 16ëª…ì´ ë³´ì¥ë˜ë¯€ë¡œ)

    const submissionStatusHtml = isSubmitted ?
        `<p class="text-center text-green-600 font-semibold mb-6 p-3 bg-green-50 rounded-lg">âœ… ì„ íƒ ì œì¶œ ì™„ë£Œ! (ê´€ë¦¬ìì˜ ë§¤ì¹­ì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.)</p>` :
        `<p class="text-center text-red-600 font-semibold mb-6 p-3 bg-red-50 rounded-lg">ğŸš¨ ì•„ì§ ì„ íƒì„ ì œì¶œí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>`;

    container.innerHTML = `
        <h2 class="text-2xl font-bold text-gray-800 mb-6">ë‚˜ì˜ ìµœì¢… ì„ íƒ (${opponentClass} ì¤‘ 3ì§€ë§ê¹Œì§€)</h2>
        ${submissionStatusHtml}
        <form id="selection-form" onsubmit="submitChoices(event)" class="space-y-4">
            <div class="flex flex-col space-y-2">
                <label for="choice1" class="font-semibold text-gray-700">1ì§€ë§ (ê°€ì¥ ì¤‘ìš”!)</label>
                <select id="choice1" required ${isSubmitted ? 'disabled' : ''} class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white">
                    <option value="">-- ${opponentClass} ì°¸ê°€ì ì¤‘ ì„ íƒí•˜ì„¸ìš” --</option>
                    ${selectionOptions}
                </select>
            </div>
            <div class="flex flex-col space-y-2">
                <label for="choice2" class="font-semibold text-gray-700">2ì§€ë§</label>
                <select id="choice2" required ${isSubmitted ? 'disabled' : ''} class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white">
                    <option value="">-- ${opponentClass} ì°¸ê°€ì ì¤‘ ì„ íƒí•˜ì„¸ìš” --</option>
                    ${selectionOptions}
                </select>
            </div>
            <div class="flex flex-col space-y-2">
                <label for="choice3" class="font-semibold text-gray-700">3ì§€ë§</label>
                <select id="choice3" required ${isSubmitted ? 'disabled' : ''} class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white">
                    <option value="">-- ${opponentClass} ì°¸ê°€ì ì¤‘ ì„ íƒí•˜ì„¸ìš” --</option>
                    ${selectionOptions}
                </select>
            </div>

            <button type="submit" ${isSubmitted ? 'disabled' : ''} class="w-full py-3 mt-6 text-white font-bold rounded-lg transition duration-150 ${isSubmitted ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 active:bg-blue-800 shadow-md hover:shadow-lg'}">
                ${isSubmitted ? 'ì œì¶œ ì™„ë£Œë¨' : 'ì„ íƒ ì œì¶œí•˜ê¸°'}
            </button>
        </form>
    `;

    // ê¸°ì¡´ ì„ íƒ ê°’ ë¡œë“œ (ì´ì œ Nickname Stringì„ ë¡œë“œ)
    if (user) {
        document.getElementById('choice1').value = user.choice1 || '';
        document.getElementById('choice2').value = user.choice2 || '';
        document.getElementById('choice3').value = user.choice3 || '';
    }
}

/**
 * ê´€ë¦¬ì ëª¨ë“œ UI ë Œë”ë§
 */
function renderAdminView() {
    // isAdminValidated ê²€ì‚¬ë¥¼ setRoleì—ì„œ ì´ë¯¸ í–ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ë Œë”ë§ë§Œ ìˆ˜í–‰
    const container = document.getElementById('mode-container');
    const total = participants.length;
    const submitted = Object.keys(submissions).length;
    const remaining = FULL_PARTICIPANT_LIST.length - submitted; // ì „ì²´ ì°¸ê°€ì 32ëª… ê¸°ì¤€ìœ¼ë¡œ ë¯¸ì œì¶œ ê³„ì‚°

    // ì°¸ê°€ì ì„ íƒ í˜„í™© í…Œì´ë¸”
    const submissionRows = participants.map(p => {
        const isSubmitted = p.submitted;
        const matchId = p.finalMatch;
        const matchNickname = matchId === 'ì†”ë¡œ' ? 'ì†”ë¡œ' : (participants.find(pt => pt.id === matchId)?.nickname || '-');

        let matchClass = 'text-gray-500';
        if (matchId && matchId !== 'ì†”ë¡œ') matchClass = 'text-pink-600 font-bold';
        else if (matchId === 'ì†”ë¡œ') matchClass = 'text-gray-400';

        // ì„ íƒ ì§€ë§ í‘œì‹œ ì‹œ ìƒëŒ€ë°© ë‹‰ë„¤ì„ ë¬¸ìì—´(choice1, 2, 3)ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
        const getChoiceDisplay = (choice) => choice || '-';

        return `
            <tr class="border-b transition duration-150 hover:bg-gray-50">
                <td class="p-3 font-semibold text-gray-900">${p.nickname}</td>
                <td class="p-3 text-center">
                    <span class="inline-block px-3 py-1 text-xs font-medium rounded-full ${isSubmitted ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                        ${isSubmitted ? 'O' : 'X'}
                    </span>
                </td>
                <td class="p-3 hidden sm:table-cell text-sm text-gray-700">${isSubmitted ? `1: ${getChoiceDisplay(p.choice1)}, 2: ${getChoiceDisplay(p.choice2)}, 3: ${getChoiceDisplay(p.choice3)}` : '-'}</td>
                <td class="p-3 text-center ${matchClass}">${matchNickname}</td>
            </tr>
        `;
    }).join('');

    // ìµœì¢… ë§¤ì¹­ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸
    const matchedPairsHtml = finalMatches.length > 0 ?
        finalMatches.map(pair => {
            const p1Name = participants.find(p => p.id === pair.p1)?.nickname || pair.p1;
            const p2Name = participants.find(p => p.id === pair.p2)?.nickname || pair.p2;
            let matchType = '';
            if (pair.type === 1) matchType = `<span class="text-red-500 font-bold">(1ì§€ë§ ìƒí˜¸)</span>`;
            else if (pair.type === 2) matchType = `<span class="text-blue-500 font-bold">(1-3ì§€ë§ ìƒí˜¸)</span>`;

            return `<li class="p-3 bg-pink-50 rounded-lg flex justify-between items-center shadow-sm">
                        <span class="font-bold text-gray-800">${p1Name} & ${p2Name}</span>
                        ${matchType}
                    </li>`;
        }).join('') :
        '<li class="p-4 text-center text-gray-500 bg-gray-50 rounded-lg">ì•„ì§ ë§¤ì¹­ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
    
    // ë¯¸ì œì¶œ ì¸ì› ê²½ê³  í…ìŠ¤íŠ¸ (ì „ì²´ 32ëª… ì¤‘ í˜„ì¬ ë‹‰ë„¤ì„ì„ ë“±ë¡í•˜ê³  ì œì¶œí•œ ì¸ì› ê¸°ì¤€)
    const submissionWarning = FULL_PARTICIPANT_LIST.length > total ? 
        `<p class="text-xs text-red-500 mt-1"> * 32ëª… ì¤‘ ë‹‰ë„¤ì„ì„ ë“±ë¡í•˜ì§€ ì•Šì€ ì°¸ê°€ì ${FULL_PARTICIPANT_LIST.length - total}ëª…ì´ ì œì™¸ëœ ${total}ëª…ì˜ ì œì¶œ í˜„í™©ì…ë‹ˆë‹¤.</p>` : '';


    container.innerHTML = `
        <h2 class="text-2xl font-bold text-gray-800 mb-4">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h2>

        <div class="grid grid-cols-3 gap-4 mb-8">
            <div class="bg-blue-50 p-4 rounded-lg text-center shadow">
                <p class="text-sm text-blue-600 font-medium">ì „ì²´ ì°¸ê°€ì</p>
                <p class="text-2xl font-extrabold text-blue-800">32ëª…</p>
            </div>
            <div class="bg-green-50 p-4 rounded-lg text-center shadow">
                <p class="text-sm text-green-600 font-medium">ì œì¶œ ì™„ë£Œ</p>
                <p class="text-2xl font-extrabold text-green-800">${submitted}ëª…</p>
            </div>
            <div class="bg-yellow-50 p-4 rounded-lg text-center shadow">
                <p class="text-sm text-yellow-600 font-medium">ë¯¸ì œì¶œ (ë‹‰ë„¤ì„ ë“±ë¡ ê¸°ì¤€)</p>
                <p class="text-2xl font-extrabold text-yellow-800">${total - submitted}ëª…</p>
            </div>
        </div>

        <div class="mb-8">
            <button onclick="runMatchingAlgorithm()" ${total !== FULL_PARTICIPANT_LIST.length || remaining > 0 || isMatchInProgress ? 'disabled' : ''} class="w-full py-4 text-white font-bold rounded-xl text-xl transition duration-150 ${total !== FULL_PARTICIPANT_LIST.length || remaining > 0 ? 'bg-red-400 cursor-not-allowed' : (isMatchInProgress ? 'bg-gray-400' : 'bg-pink-600 hover:bg-pink-700 active:bg-pink-800 shadow-lg')}">
                ${isMatchInProgress ? 'ë§¤ì¹­ ê³„ì‚° ì¤‘...' : (total !== FULL_PARTICIPANT_LIST.length ? 'ğŸš¨ ì „ì²´ 32ëª… ë‹‰ë„¤ì„ ë“±ë¡ ì™„ë£Œ í•„ìš”' : (remaining > 0 ? `ğŸš¨ ${remaining}ëª… ë¯¸ì œì¶œ! ë§¤ì¹­ ë¶ˆê°€` : 'ğŸ’– ìµœì¢… ë§¤ì¹­ ìë™í™” ì‹¤í–‰'))}
            </button>
            ${submissionWarning}
        </div>

        <h3 class="text-xl font-bold text-gray-800 mb-3 border-t pt-6">ê²°ê³¼: ë§¤ì¹­ëœ ì»¤í”Œ (${finalMatches.length}ìŒ)</h3>
        <ul class="space-y-3 mb-8">
            ${matchedPairsHtml}
        </ul>

        <h3 class="text-xl font-bold text-gray-800 mb-3 border-t pt-6">ì°¸ê°€ìë³„ ì„ íƒ ë° ë§¤ì¹­ í˜„í™©</h3>
        <div class="overflow-x-auto bg-gray-50 rounded-xl shadow-inner">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">ë‹‰ë„¤ì„</th>
                        <th class="p-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">ì œì¶œ</th>
                        <th class="p-3 hidden sm:table-cell text-left text-xs font-bold text-gray-600 uppercase tracking-wider">ì„ íƒ ì§€ë§ (1, 2, 3)</th>
                        <th class="p-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">ìµœì¢… ë§¤ì¹­</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    ${submissionRows}
                </tbody>
            </table>
        </div>

        <div class="mt-8 p-4 bg-gray-100 rounded-lg text-sm text-gray-600">
            <p class="font-bold mb-1">ğŸ“¢ ë§¤ì¹­ ê·œì¹™ ìš”ì•½:</p>
            <ul class="list-disc list-inside space-y-1">
                <li>1ìˆœìœ„: ìƒí˜¸ 1ì§€ë§ ë§¤ì¹­ (ìš°ì„  ì²˜ë¦¬)</li>
                <li>2ìˆœìœ„: 1ìˆœìœ„ì—ì„œ ì œì™¸ëœ ì¸ì› ì¤‘, ìƒí˜¸ 1~3ì§€ë§ ë§¤ì¹­</li>
                <li>ë§¤ì¹­ëœ ì¸ì›ì€ ë‹¤ìŒ ë§¤ì¹­ ìˆœì„œì—ì„œ ìë™ ì œì™¸ë©ë‹ˆë‹¤.</li>
            </ul>
        </div>
    `;
}

// --------------------------------------------------------
// 4. ì°¸ê°€ì ì„ íƒ ì œì¶œ
// --------------------------------------------------------
async function submitChoices(event) {
    event.preventDefault();
    const form = event.target;
    const choice1 = form.choice1.value; // Nickname String
    const choice2 = form.choice2.value; // Nickname String
    const choice3 = form.choice3.value; // Nickname String

    // ì¤‘ë³µ ì„ íƒ ê²€ì¦
    const choices = [choice1, choice2, choice3];
    const uniqueChoices = new Set(choices);
    if (choices.length !== uniqueChoices.size) {
        showModal('1ì§€ë§, 2ì§€ë§, 3ì§€ë§ì€ ì„œë¡œ ë‹¤ë¥¸ ìƒëŒ€ë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.', false);
        return;
    }

    // Nicknameì€ í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ë‹‰ë„¤ì„ê³¼ ë‹¤ë¥¼ ê²ƒì´ë¯€ë¡œ, self-selection checkëŠ” í•„ìš” ì—†ìŒ

    showModal('ì„ íƒ ì •ë³´ë¥¼ ì œì¶œí•˜ëŠ” ì¤‘...', true);

    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'participants', currentUserId);

    try {
        // ì´ì œ choice1, choice2, choice3 í•„ë“œì—ëŠ” ìƒëŒ€ë°©ì˜ ë‹‰ë„¤ì„ ë¬¸ìì—´ì´ ì €ì¥ë©ë‹ˆë‹¤.
        await setDoc(docRef, {
            choice1: choice1,
            choice2: choice2,
            choice3: choice3,
            submitted: true,
        }, { merge: true });

        hideModal();
        showModal('âœ… ì„ íƒ ì œì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', false);
        renderParticipantView(); // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
    } catch (e) {
        console.error("ì„ íƒ ì œì¶œ ì˜¤ë¥˜:", e);
        showModal(`ì œì¶œ ì‹¤íŒ¨: ${e.message}`, false);
    }
}

// --------------------------------------------------------
// 5. í•µì‹¬: ë§¤ì¹­ ì•Œê³ ë¦¬ì¦˜ (ê´€ë¦¬ì ì‹¤í–‰)
// --------------------------------------------------------

/**
 * ìµœì¢… ë§¤ì¹­ ì•Œê³ ë¦¬ì¦˜ ì‹¤í–‰
 */
async function runMatchingAlgorithm() {
    if (isMatchInProgress) return;
    
    // ë³´ì•ˆ ê²€ì¦ (í´ë¼ì´ì–¸íŠ¸ UIë¡œë§Œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì²˜ë¦¬í•˜ì§€ë§Œ, í•¨ìˆ˜ í˜¸ì¶œ ì‹œì—ë„ í”Œë˜ê·¸ í™•ì¸)
    if (!isAdminValidated) {
        showModal('ğŸš¨ ê´€ë¦¬ì ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', false);
        return;
    }
    
    // ëª¨ë“  32ëª…ì´ ë‹‰ë„¤ì„ ë“±ë¡ ë° ì œì¶œì„ ì™„ë£Œí–ˆëŠ”ì§€ ìµœì¢… í™•ì¸
    const totalParticipantsRegistered = participants.length;
    const totalParticipantsSubmitted = Object.keys(submissions).length;

    if (totalParticipantsRegistered !== FULL_PARTICIPANT_LIST.length) {
        showModal(`ğŸš¨ ì „ì²´ 32ëª… ì¤‘ ${FULL_PARTICIPANT_LIST.length - totalParticipantsRegistered}ëª…ì´ ì•„ì§ ë‹‰ë„¤ì„ì„ ë“±ë¡í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë§¤ì¹­ì„ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, false);
        return;
    }
    if (totalParticipantsSubmitted !== FULL_PARTICIPANT_LIST.length) {
        showModal(`ğŸš¨ ì „ì²´ 32ëª… ì¤‘ ${FULL_PARTICIPANT_LIST.length - totalParticipantsSubmitted}ëª…ì´ ì•„ì§ ì„ íƒì„ ì œì¶œí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë§¤ì¹­ì„ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, false);
        return;
    }


    isMatchInProgress = true;
    showModal('ğŸ’– ìµœì¢… ë§¤ì¹­ ì•Œê³ ë¦¬ì¦˜ì„ ì‹¤í–‰í•©ë‹ˆë‹¤...', true);

    // ë§¤ì¹­ì„ ìœ„í•´ ëª¨ë“  ì°¸ê°€ì ë°ì´í„°ì™€ ì„ íƒ ì •ë³´ë¥¼ ê°€ì ¸ì˜´ (ì‹¤ì‹œê°„ ë°ì´í„° í™œìš©)
    const allParticipants = participants; // ë‹‰ë„¤ì„ ë“±ë¡ì„ ì™„ë£Œí•œ 32ëª…
    const matches = [];
    const matchedIds = new Set();
    
    // ID <-> ë°ì´í„° ë§µ (P1ì˜ ID ì°¾ê¸°ìš©)
    const participantDataMap = new Map();
    allParticipants.forEach(p => participantDataMap.set(p.id, p));

    // Nickname <-> ID ë§µ (P1ì´ ì„ íƒí•œ ë‹‰ë„¤ì„ì˜ ID ì°¾ê¸°ìš©)
    const participantIdByNickname = new Map();
    allParticipants.forEach(p => participantIdByNickname.set(p.nickname, p.id));


    // -------------------------
    // Phase 1: ìƒí˜¸ 1ì§€ë§ ë§¤ì¹­ (ìš°ì„  ë§¤ì¹­)
    // -------------------------
    for (const p1 of allParticipants) {
        if (matchedIds.has(p1.id)) continue; 
        if (!p1.submitted) continue; // ì œì¶œí•˜ì§€ ì•Šì€ ì‚¬ëŒì€ ë§¤ì¹­ ëŒ€ìƒì—ì„œ ì œì™¸

        const p2Nickname = p1.choice1;
        
        // p1ì´ ì„ íƒí•œ ìƒëŒ€ë°©(p2)ì´ ë‹‰ë„¤ì„ ë“±ë¡ì„ ì™„ë£Œí–ˆëŠ”ì§€ í™•ì¸
        const p2Id = participantIdByNickname.get(p2Nickname);
        const p2 = participantDataMap.get(p2Id);

        if (!p2 || matchedIds.has(p2Id) || !p2.submitted) continue; // ìƒëŒ€ë°© ë¯¸ë“±ë¡/ì´ë¯¸ ë§¤ì¹­/ë¯¸ì œì¶œ ì‹œ ì œì™¸

        // ìƒí˜¸ 1ì§€ë§ í™•ì¸: P2ì˜ 1ì§€ë§ ë‹‰ë„¤ì„ì´ P1ì˜ ë‹‰ë„¤ì„ê³¼ ì¼ì¹˜í•˜ëŠ”ê°€?
        if (p2.choice1 === p1.nickname) { 
            matches.push({ p1: p1.id, p2: p2Id, type: 1 }); // type 1: 1ì§€ë§ ë§¤ì¹­
            matchedIds.add(p1.id);
            matchedIds.add(p2Id);
        }
    }
    console.log(`Phase 1 ì™„ë£Œ: ìƒí˜¸ 1ì§€ë§ ë§¤ì¹­ ${matches.length}ìŒ`);

    // -------------------------
    // Phase 2: ìƒí˜¸ 1~3ì§€ë§ ë§¤ì¹­ (ì°¨ìˆœ ë§¤ì¹­)
    // -------------------------
    for (const p1 of allParticipants) {
        if (matchedIds.has(p1.id)) continue; 
        if (!p1.submitted) continue;

        const p1ChoicesNicknames = [p1.choice1, p1.choice2, p1.choice3];

        for (const p2Nickname of p1ChoicesNicknames) {
            // P1ì´ ì„ íƒí•œ ìƒëŒ€ë°©(p2)ì´ ë‹‰ë„¤ì„ ë“±ë¡ì„ ì™„ë£Œí–ˆëŠ”ì§€ í™•ì¸
            const p2Id = participantIdByNickname.get(p2Nickname);
            if (!p2Id || matchedIds.has(p2Id)) continue; 

            const p2 = participantDataMap.get(p2Id);
            if (!p2 || !p2.submitted) continue; // ìƒëŒ€ë°© ë¯¸ë“±ë¡/ë¯¸ì œì¶œ ì‹œ ì œì™¸

            const p2ChoicesNicknames = [p2.choice1, p2.choice2, p2.choice3];

            // P2ê°€ P1ì„ 1~3ì§€ë§ ì´ë‚´ì— ì„ íƒí–ˆëŠ”ì§€ í™•ì¸ (P1ì˜ ë‹‰ë„¤ì„ ì‚¬ìš©)
            if (p2ChoicesNicknames.includes(p1.nickname)) {
                matches.push({ p1: p1.id, p2: p2Id, type: 2 }); // type 2: 1~3ì§€ë§ ë§¤ì¹­
                matchedIds.add(p1.id);
                matchedIds.add(p2Id);
                break; // P1ì˜ ë§¤ì¹­ì´ ì„±ê³µí–ˆìœ¼ë¯€ë¡œ ë‹¤ìŒ ì°¸ê°€ìë¡œ ë„˜ì–´ê°
            }
        }
    }
    console.log(`Phase 2 ì™„ë£Œ: ìµœì¢… ë§¤ì¹­ ${matches.length}ìŒ`);

    // -------------------------
    // 3. Firestoreì— ìµœì¢… ê²°ê³¼ ì €ì¥ ë° ì°¸ê°€ì ë°ì´í„° ì—…ë°ì´íŠ¸
    // -------------------------
    const batch = writeBatch(db);
    const allMatchIds = new Set(matches.flatMap(m => [m.p1, m.p2]));

    try {
        // ë§¤ì¹­ ê²°ê³¼ ë¬¸ì„œ ì €ì¥ (ê°€ì¥ ìµœì‹  ê²°ê³¼ë§Œ ë‚¨ê¸°ê¸° ìœ„í•´ í•­ìƒ ë™ì¼í•œ ID ì‚¬ìš©)
        const matchResultRef = doc(db, 'artifacts', appId, 'public', 'data', 'matches', 'latestResult');
        batch.set(matchResultRef, {
            result: matches,
            timestamp: Date.now(),
            totalMatches: matches.length
        });

        // ê° ì°¸ê°€ì ë¬¸ì„œ ì—…ë°ì´íŠ¸
        allParticipants.forEach(p => {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'participants', p.id);
            let finalMatchId = 'ì†”ë¡œ'; // ê¸°ë³¸ê°’ì€ ì†”ë¡œ

            // ë§¤ì¹­ëœ ì§ì„ ì°¾ìŒ
            for (const match of matches) {
                if (match.p1 === p.id) {
                    finalMatchId = match.p2;
                    break;
                } else if (match.p2 === p.id) {
                    finalMatchId = match.p1;
                    break;
                }
            }

            batch.update(docRef, {
                finalMatch: finalMatchId // ì†”ë¡œì´ê±°ë‚˜ ìƒëŒ€ë°© ID
            });
        });

        await batch.commit();

        hideModal();
        showModal(`âœ… ìµœì¢… ë§¤ì¹­ ì™„ë£Œ! ì´ ${matches.length}ìŒì´ íƒ„ìƒí–ˆìŠµë‹ˆë‹¤.`, false);
        isMatchInProgress = false;
        renderAdminView(); // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸

    } catch (e) {
        console.error("ë§¤ì¹­ ê²°ê³¼ ì €ì¥ ë° ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", e);
        showModal(`ë§¤ì¹­ ì €ì¥ ì‹¤íŒ¨: ${e.message}`, false);
        isMatchInProgress = false;
    }
}

// --------------------------------------------------------
// 6. ìœ í‹¸ë¦¬í‹° (ëª¨ë‹¬)
// --------------------------------------------------------
function showModal(message, showSpinner) {
    document.getElementById('modal-message').textContent = message;
    document.getElementById('modal-backdrop').classList.remove('hidden');
    document.getElementById('modal-backdrop').classList.add('flex');

    if (showSpinner) {
        document.getElementById('modal-spinner').classList.remove('hidden');
        document.getElementById('modal-close-btn').classList.add('hidden');
    } else {
        document.getElementById('modal-spinner').classList.add('hidden');
        document.getElementById('modal-close-btn').classList.remove('hidden');
    }
}

function hideModal() {
    document.getElementById('modal-backdrop').classList.add('hidden');
    document.getElementById('modal-backdrop').classList.remove('flex');
}

// ì „ì—­ í•¨ìˆ˜ ë…¸ì¶œ (HTMLì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•˜ë„ë¡)
window.setRole = setRole;
window.handleAdminClick = handleAdminClick; // ê´€ë¦¬ì í´ë¦­ í•¸ë“¤ëŸ¬ ë…¸ì¶œ
window.checkAdminKeyAndProceed = checkAdminKeyAndProceed; // í‚¤ ì²´í¬ í•¨ìˆ˜ ë…¸ì¶œ
window.submitSetupForm = submitSetupForm; // ë‹‰ë„¤ì„ ì„¤ì • í¼ ì œì¶œ í•¨ìˆ˜ ë…¸ì¶œ
window.updateCalculatedNickname = updateCalculatedNickname; // ë‹‰ë„¤ì„ ê³„ì‚° í•¨ìˆ˜ ë…¸ì¶œ
window.submitChoices = submitChoices;
window.runMatchingAlgorithm = runMatchingAlgorithm;
window.hideModal = hideModal;

// ì‹œì‘
initializeFirebase();
